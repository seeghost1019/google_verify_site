<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>114å¹´åº¦å˜‰æ¦®æ°¸çºŒç”Ÿæ´»è¡Œå‹•ææ¡ˆ - æ±ºç­–è¼”åŠ©ç³»çµ± (Firebaseç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Noto Sans TC', sans-serif; background-color: #f0fdf4; color: #1a202c; }
        .chart-container { position: relative; width: 100%; max-width: 800px; margin: 0 auto; height: 400px; max-height: 500px; }
        @media (max-width: 640px) { .chart-container { height: 300px; } }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }
        .active-tab { border-bottom: 2px solid #166534; color: #166534; font-weight: 700; }
        .inactive-tab { color: #6b7280; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        /* Toast */
        #toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 100; }
        .toast { background-color: #064e3b; color: white; padding: 12px 24px; border-radius: 8px; margin-top: 10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); animation: slideIn 0.3s ease-out, fadeOut 0.5s ease-in 2.5s forwards; }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes fadeOut { from { opacity: 1; } to { opacity: 0; } }
        
        /* Config Modal */
        #config-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.8); z-index: 9999; display: flex; justify-content: center; align-items: center; }
    </style>
</head>
<body class="bg-stone-50 text-stone-800">

    <!-- Config Screen -->
    <div id="config-overlay" class="hidden">
        <div class="bg-white p-8 rounded-xl shadow-2xl max-w-lg w-full mx-4 max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-emerald-800 mb-2">è¨­å®šé€£ç·šæ¨¡å¼</h2>
            <p class="text-gray-600 mb-6 text-sm">è«‹é¸æ“‡æ‚¨è¦ä½¿ç”¨çš„é‹ä½œæ¨¡å¼ï¼š</p>
            
            <div class="space-y-4">
                <!-- Cloud Option -->
                <div class="border border-emerald-200 bg-emerald-50 rounded-lg p-4 transition">
                    <label class="font-bold text-emerald-900 block mb-2 flex items-center gap-2">
                        ğŸ”¥ Firebase é›²ç«¯é€£ç·š (æ¨è–¦)
                        <span class="bg-red-500 text-white text-xs px-2 py-0.5 rounded">å³æ™‚</span>
                    </label>
                    <p class="text-xs text-gray-600 mb-2">è«‹å°‡ Firebase Console ä¸­çš„ <code class="bg-gray-200 px-1 rounded">firebaseConfig</code> ç‰©ä»¶å…§å®¹è²¼åœ¨ä¸‹æ–¹ï¼š</p>
                    <textarea id="firebase-config-input" rows="6" placeholder='{
  "apiKey": "AIzaSy...",
  "authDomain": "...",
  "projectId": "...",
  "storageBucket": "...",
  "messagingSenderId": "...",
  "appId": "..."
}' class="w-full border border-gray-300 rounded p-2 mb-2 text-xs font-mono focus:ring-2 focus:ring-emerald-500 outline-none"></textarea>
                    <button onclick="saveFirebaseConfig()" class="w-full bg-emerald-600 text-white font-bold py-2 rounded hover:bg-emerald-700 transition text-sm">é€£ç·šä¸¦é–‹å§‹</button>
                </div>

                <div class="relative flex py-2 items-center">
                    <div class="flex-grow border-t border-gray-300"></div>
                    <span class="flex-shrink mx-4 text-gray-400 text-xs">æˆ–æ˜¯</span>
                    <div class="flex-grow border-t border-gray-300"></div>
                </div>

                <!-- Local Option -->
                <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition cursor-pointer" onclick="useLocalMode()">
                    <label class="font-bold text-gray-800 block cursor-pointer">ğŸ’» å–®æ©Ÿæ¼”ç¤ºæ¨¡å¼ (ä¸éœ€ç¶²è·¯)</label>
                    <p class="text-xs text-gray-500 mb-3">ç¥¨æ•¸åƒ…å„²å­˜åœ¨é€™å°é›»è…¦ä¸Šï¼Œé©åˆå±•ç¤ºç”¨ã€‚</p>
                    <button class="w-full bg-gray-600 text-white font-bold py-2 rounded hover:bg-gray-700 transition text-sm">ä½¿ç”¨å–®æ©Ÿæ¨¡å¼</button>
                </div>
            </div>
            <div class="mt-4 text-xs text-gray-400 text-center">
                * è²¼å¿ƒæé†’ï¼šè«‹ç¢ºèªæ‚¨çš„ Firebase Firestore è¦å‰‡å·²è¨­ç‚ºæ¸¬è©¦æ¨¡å¼ (Test Mode)ã€‚
            </div>
        </div>
    </div>

    <!-- Navbar -->
    <header class="bg-emerald-800 text-white shadow-lg sticky top-0 z-50">
        <div class="container mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center">
            <div class="mb-2 md:mb-0 text-center md:text-left">
                <h1 class="text-xl md:text-2xl font-bold">114å¹´åº¦æ°¸çºŒç”Ÿæ´»è¡Œå‹•ææ¡ˆ</h1>
                <p class="text-sm text-emerald-100">æ±ºç­–è¼”åŠ©ç³»çµ± <span id="mode-indicator" class="ml-2 bg-white/20 px-2 py-0.5 rounded text-xs">...</span></p>
            </div>
            <nav class="flex gap-4 text-sm items-center flex-wrap justify-center">
                <button onclick="scrollToSection('strategy-section')" class="hover:text-emerald-200 transition">ç­–ç•¥åˆ†æ</button>
                <button onclick="scrollToSection('catalog-section')" class="hover:text-emerald-200 transition">å…«å¤§é¢å‘ç¸½è¦½</button>
                <button onclick="openResults()" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded-full font-bold shadow-md transition transform hover:scale-105 flex items-center gap-2">
                    <span>ğŸ†</span> <span id="nav-live-count">æŸ¥çœ‹å³æ™‚æˆ°æ³</span>
                </button>
                <button onclick="resetConfig()" class="text-xs text-emerald-300 underline hover:text-white" title="é‡è¨­é€£ç·š">âš™ï¸</button>
            </nav>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8 space-y-12">
        <!-- Strategy Section -->
        <section id="strategy-section" class="bg-white rounded-2xl shadow-sm border border-stone-200 p-6">
            <div class="mb-6">
                <h3 class="text-2xl font-bold text-emerald-800 flex items-center gap-2"><span>ğŸ“Š</span> ææ¡ˆç­–ç•¥åˆ†æçŸ©é™£</h3>
                <p class="text-gray-500 mt-2">é»æ“Šæ°£æ³¡å¯æŸ¥çœ‹è©³æƒ…ä¸¦é€²è¡ŒæŠ•ç¥¨ã€‚</p>
            </div>
            <div class="w-full flex justify-center"><div class="chart-container"><canvas id="strategyChart"></canvas></div></div>
            <div class="mt-4 flex flex-wrap gap-4 justify-center text-sm text-gray-500">
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-emerald-500"></span> æ–¹æ¡ˆ A (åˆ¶åº¦)</div>
                <div class="flex items-center gap-2"><span class="w-3 h-3 rounded-full bg-blue-500"></span> æ–¹æ¡ˆ B (è¡Œå‹•)</div>
            </div>
        </section>

        <!-- Catalog Section -->
        <section id="catalog-section" class="space-y-6">
            <div class="border-l-4 border-emerald-600 pl-4 flex justify-between items-end">
                <div>
                    <h3 class="text-2xl font-bold text-gray-800">å…«å¤§é¢å‘ææ¡ˆç¸½è¦½</h3>
                    <p class="text-gray-600 mt-1">é»æ“Šå¡ç‰‡å±•é–‹ A/B æ–¹æ¡ˆä¸¦æŠ•ä¸‹ç¥è–çš„ä¸€ç¥¨ã€‚</p>
                </div>
                <div class="hidden md:block text-right">
                    <p id="status-text" class="text-sm text-emerald-600 font-bold">ğŸŸ¢ ç³»çµ±å°±ç·’</p>
                    <p id="sub-status-text" class="text-xs text-gray-400">ç­‰å¾…æ“ä½œ</p>
                </div>
            </div>
            <div id="categories-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6"></div>
        </section>

        <!-- Detail Modal -->
        <section id="detail-view" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-y-auto relative animate-fade-in">
                <button onclick="closeDetail()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 text-2xl font-bold">&times;</button>
                <div id="detail-content" class="p-6 md:p-10"></div>
            </div>
        </section>

        <!-- Results Modal -->
        <section id="results-view" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4 overflow-y-auto backdrop-blur-sm">
            <div class="bg-white rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto relative animate-fade-in">
                <button onclick="closeResults()" class="absolute top-4 right-4 text-gray-400 hover:text-gray-700 p-2 text-2xl font-bold">&times;</button>
                <div class="p-8">
                    <div class="flex justify-between items-center mb-2">
                        <h2 class="text-3xl font-bold text-emerald-800 flex items-center gap-2">ğŸ† å³æ™‚ç¥¨é¸æ’è¡Œæ¦œ</h2>
                        <span id="results-badge" class="bg-gray-600 text-white text-xs px-2 py-1 rounded">Local</span>
                    </div>
                    <p class="text-gray-600 mb-6">å…¨é«”åŒä»çš„æŠ•ç¥¨çµæœã€‚</p>
                    <div class="chart-container mb-6"><canvas id="resultsChart"></canvas></div>
                    <div class="flex justify-end gap-4">
                         <button onclick="resetVotes()" class="text-red-500 hover:text-red-700 text-sm font-medium underline mr-auto">âš ï¸ é‡ç½®æ‰€æœ‰ç¥¨æ•¸</button>
                        <button onclick="closeResults()" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg font-medium transition">é—œé–‰</button>
                    </div>
                </div>
            </div>
        </section>

        <div id="toast-container"></div>
    </main>

    <footer class="bg-stone-100 border-t border-stone-200 mt-12 py-8 text-center text-gray-500 text-sm">
        <p>Â© 114å¹´åº¦å˜‰æ¦®æ°¸çºŒç”Ÿæ´»è¡Œå‹•ææ¡ˆç«¶è³½ - æ±ºç­–è¼”åŠ©ç³»çµ±</p>
    </footer>

    <!-- Import Firebase (ES Modules) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, onSnapshot, updateDoc, increment } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

        // Global Firebase vars
        window.firebaseApp = null;
        window.db = null;
        window.firestoreModules = { collection, doc, setDoc, onSnapshot, updateDoc, increment };

        window.initFirebase = function(config) {
            try {
                window.firebaseApp = initializeApp(config);
                window.db = getFirestore(window.firebaseApp);
                console.log("Firebase initialized");
                
                // Start Listening
                const votesCol = collection(window.db, "votes");
                onSnapshot(votesCol, (snapshot) => {
                    const newVotes = {};
                    snapshot.forEach((doc) => {
                        newVotes[doc.id] = doc.data().count;
                    });
                    window.updateGlobalVotes(newVotes);
                });
                return true;
            } catch (e) {
                console.error("Firebase init error", e);
                alert("Firebase é€£ç·šå¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®šæª”æ ¼å¼æ˜¯å¦æ­£ç¢ºã€‚\n" + e.message);
                return false;
            }
        };

        window.castVoteFirebase = async function(id, type) {
            if (!window.db) return;
            const key = `${id}-${type}`;
            const docRef = doc(window.db, "votes", key);
            try {
                // Use setDoc with merge to handle both create and update
                await setDoc(docRef, { count: increment(1) }, { merge: true });
                window.showToast(`ğŸ”¥ å·²æŠ•çµ¦ #${key} (é›²ç«¯åŒæ­¥)`);
            } catch (e) {
                console.error("Vote Error", e);
                alert("æŠ•ç¥¨å¤±æ•—ï¼šè«‹æª¢æŸ¥ Firestore è¦å‰‡æ˜¯å¦å·²è¨­ç‚º Test Mode (å…è¨±è®€å¯«)ã€‚\n" + e.message);
            }
        }
        
        window.resetVotesFirebase = async function() {
            // Firestore doesn't support "delete collection" from client easily.
            // We will just alert user.
            alert("Firebase æ¨¡å¼ä¸‹ï¼Œè«‹ç›´æ¥åˆ° Firebase Console å¾Œå°åˆªé™¤ 'votes' é›†åˆä¸­çš„æ–‡ä»¶å³å¯é‡ç½®ã€‚");
        }
    </script>

    <script>
        // --- DATA ---
        const proposalsData = [
            { id: "01", name: "ç¯€èƒ½çœé›»", slogan: "çœé›»å‹•ä¸€å‹•", icon: "âš¡", planA: { type: "A", title: "ç¶ è‰²å‡ºå‹¤ï¼Œé›¢å®¤æ–·é›»", desc: "å»ºç«‹é›¢å®¤æª¢æ ¸æ›ç‰Œåˆ¶åº¦ã€‚", effort: 3, impact: 7, action: "è£½ä½œæ›ç‰Œï¼Œé›¢é–‹ç¿»ç‰Œç¢ºèªã€‚" }, planB: { type: "B", title: "é€±æœ«æ‹”æ’é ­ï¼Œå¾…æ©Ÿæ­¸é›¶", desc: "é€±äº”ä¸‹ç­æ‹”é™¤éå¿…è¦æ’é ­ã€‚", effort: 2, impact: 6, action: "æ¨™ç¤ºæ’åº§ï¼Œé€±äº”å»£æ’­åŸ·è¡Œã€‚" } },
            { id: "02", name: "çœæ°´æœ‰é“", slogan: "æ»´æ°´ä¸æ¼æ‰", icon: "ğŸ’§", planA: { type: "A", title: "æƒœæ°´å¦‚é‡‘ï¼Œæ•™å…·æ¸…æ´—SOP", desc: "æ”¹æµ¸æ³¡æ¸…æ´—ï¼Œå»¢æ°´å†åˆ©ç”¨ã€‚", effort: 4, impact: 6, action: "å»ºç«‹ä¸‰æ®µå¼æ¸…æ´—æµç¨‹ã€‚" }, planB: { type: "B", title: "é™¤æº¼å›æ”¶ï¼Œæ¾†çŒç¶ æ„", desc: "å›æ”¶é™¤æ¿•æ©Ÿæ°´æ¾†èŠ±æ‹–åœ°ã€‚", effort: 3, impact: 5, action: "è¨­ç½®å›æ”¶æ°´æ¡¶å†åˆ©ç”¨ã€‚" } },
            { id: "03", name: "æ¸›å¡‘ç”Ÿæ´»", slogan: "ç’°ä¿æœ€æ™‚å°š", icon: "ğŸ›ï¸", planA: { type: "A", title: "ç„¡å¡‘ç¤¾å€è¡Œï¼Œè£å‚™è¢‹è®Šèº«", desc: "ä½¿ç”¨æ¨¡çµ„åŒ–æ”¶ç´ç®±å–ä»£å¡‘è† è¢‹ã€‚", effort: 5, impact: 8, action: "å°å…¥æ¨™ç±¤åŒ–æ”¶ç´ç®±ã€‚" }, planB: { type: "B", title: "æœƒè­°ä¸ç“¶è£ï¼ŒèŒ¶æ°´è‡ªå·±è£", desc: "åœæ­¢æä¾›ç“¶è£æ°´ï¼Œæ”¹å¤§æ¡¶èŒ¶ã€‚", effort: 2, impact: 7, action: "è‡ªå‚™ç’°ä¿æ¯ï¼Œç¾å ´ä¾›èŒ¶æ¡¶ã€‚" } },
            { id: "04", name: "å»¢æ£„æ¸›é‡", slogan: "å›æ”¶ä¸éº»ç…©", icon: "ğŸ“±", planA: { type: "A", title: "é›²ç«¯è¡›æ•™ï¼Œæƒç¢¼å–ä»£å‚³å–®", desc: "è¡›æ•™å–®å¼µæ•¸ä½åŒ–æƒQR Codeã€‚", effort: 3, impact: 9, action: "è£½ä½œåœ–å¡ä¸Šå‚³é›²ç«¯ã€‚" }, planB: { type: "B", title: "å»¢ç´™é‡ç”Ÿï¼Œç­†è¨˜å‚³æ‰¿", desc: "å–®é¢å»¢ç´™è£½æˆä¾¿æ¢ç´™ã€‚", effort: 4, impact: 4, action: "è£åˆ‡è£è¨‚å…§éƒ¨ä½¿ç”¨ã€‚" } },
            { id: "05", name: "ä½ç¢³é£²é£Ÿ", slogan: "åƒç•¶å­£æœ€å¥½", icon: "ğŸ¥¦", planA: { type: "A", title: "å˜‰é„‰å‘³ãƒ»ç¶ é£ŸåŠ› (å¼·åŠ›æ¨è–¦)", desc: "è¡›æ•™èå…¥å˜‰ç¾©åœ¨åœ°ç•¶å­£é£Ÿæã€‚", effort: 2, impact: 9, action: "æ•™é•·è€…åƒåœ¨åœ°ã€åƒç•¶å­£ã€‚" }, planB: { type: "B", title: "æƒœé£Ÿå…‰ç›¤ï¼Œå¥åº·ä¸ç•™é¤˜", desc: "æ¨å‹•é©é‡é»é¤èˆ‡æ‰“åŒ…ã€‚", effort: 3, impact: 5, action: "èª¿æŸ¥é£¯é‡ï¼Œé¼“å‹µæ‰“åŒ…ã€‚" } },
            { id: "06", name: "ç¶ è‰²äº¤é€š", slogan: "å‡ºé–€å°‘æ’ç¢³", icon: "ğŸš—", planA: { type: "A", title: "å…±ä¹˜ç‰¹æ”»éšŠï¼Œè·¯å¾‘æœ€ä½³åŒ–", desc: "å¼·åˆ¶æ»¿è¼‰å…±ä¹˜èˆ‡é †è·¯å·¡è¿´ã€‚", effort: 7, impact: 8, action: "æ’ç­å¯©æŸ¥è·¯ç·šã€‚" }, planB: { type: "B", title: "è¦–è¨Šé›¶è·é›¢ï¼Œæœƒè­°å…å¥”æ³¢", desc: "è¡Œæ”¿æœƒè­°æ”¹ç·šä¸Šé€²è¡Œã€‚", effort: 2, impact: 8, action: "éå¿…è¦æ”¹Teams/Lineã€‚" } },
            { id: "07", name: "ç¶ è‰²æ¡è³¼", slogan: "è²·å°æ›´æ°¸çºŒ", icon: "ğŸ›’", planA: { type: "A", title: "ç¶ è‰²å¿ƒæ„ï¼Œç¦®è¼•æƒ…æ„é‡", desc: "è´ˆå“é¸ç”¨ç’°ä¿æ¨™ç« ç”¢å“ã€‚", effort: 2, impact: 6, action: "å„ªå…ˆæ¡è³¼ç’°ä¿æ¨™ç« å“ã€‚" }, planB: { type: "B", title: "è£œå……ä»£æ›¿è³¼è²·ï¼Œå¤§æ¡¶åˆ’ç®—", desc: "è²·å¤§æ¡¶è£æ¸…æ½”åŠ‘è‡ªè¡Œåˆ†è£ã€‚", effort: 3, impact: 5, action: "è²·5Lè£œå……æ¶²å¡«å……èˆŠç“¶ã€‚" } },
            { id: "08", name: "å…¨å“¡åƒèˆ‡", slogan: "ç¶ æ´»ä¸€èµ·è¡Œ", icon: "ğŸ¤", planA: { type: "A", title: "ç¤¾ç‡Ÿä¸­å¿ƒç¶ è‰²å­˜æ‘º", desc: "é›†é»å¡æ¿€å‹µåŒä»è½å¯¦ç’°ä¿ã€‚", effort: 5, impact: 7, action: "è‡ªå¸¶æ¯çˆ¬æ¢¯å¯é›†é»ã€‚" }, planB: { type: "B", title: "èˆŠæ„›æ–°æ­¡ï¼Œå¥½æ›¸äº¤æ›", desc: "è¨­ç½®è¾¦å…¬å®¤æ¼‚æ›¸ç«™ã€‚", effort: 2, impact: 4, action: "è¨­ç½®æ¼‚æ›¸ç®±è‡ªç”±äº¤æ›ã€‚" } }
        ];

        // --- STATE & CONFIG ---
        let globalVotes = {}; 
        let isLocalMode = true; // Default to local unless configured
        
        // --- INIT CHECK ---
        function checkConfig() {
            const savedMode = localStorage.getItem('app_mode');
            const savedConfig = localStorage.getItem('firebase_config');

            if (savedMode === 'firebase' && savedConfig) {
                // Auto-login to firebase
                isLocalMode = false;
                // We need to wait for modules to load, so we use a small timeout or check
                setTimeout(() => {
                    if (window.initFirebase) {
                        const success = window.initFirebase(JSON.parse(savedConfig));
                        if(success) {
                            initCloudUI();
                            return;
                        }
                    }
                    // Fallback
                    document.getElementById('config-overlay').classList.remove('hidden');
                }, 500);
            } else if (savedMode === 'local') {
                initLocalMode();
            } else {
                // First time
                document.getElementById('config-overlay').classList.remove('hidden');
            }
        }

        function saveFirebaseConfig() {
            const input = document.getElementById('firebase-config-input').value.trim();
            try {
                const config = JSON.parse(input); // Validate JSON
                if (!config.apiKey || !config.projectId) throw new Error("ç¼ºå°‘å¿…è¦çš„ apiKey æˆ– projectId");
                
                // Try init
                if (window.initFirebase(config)) {
                    localStorage.setItem('firebase_config', JSON.stringify(config));
                    localStorage.setItem('app_mode', 'firebase');
                    isLocalMode = false;
                    document.getElementById('config-overlay').classList.add('hidden');
                    initCloudUI();
                    showToast("Firebase é€£ç·šæˆåŠŸï¼");
                }
            } catch (e) {
                alert("è¨­å®šæª”æ ¼å¼éŒ¯èª¤ï¼Œè«‹ç¢ºä¿è¤‡è£½çš„æ˜¯å®Œæ•´çš„ JSON ç‰©ä»¶ (åŒ…å«å¤§æ‹¬è™Ÿ)ã€‚\n" + e.message);
            }
        }

        function useLocalMode() {
            localStorage.setItem('app_mode', 'local');
            isLocalMode = true;
            document.getElementById('config-overlay').classList.add('hidden');
            initLocalMode();
            showToast("å·²åˆ‡æ›è‡³å–®æ©Ÿæ¼”ç¤ºæ¨¡å¼");
        }

        function resetConfig() {
            localStorage.removeItem('app_mode');
            localStorage.removeItem('firebase_config');
            location.reload();
        }

        function initLocalMode() {
            document.getElementById('mode-indicator').innerText = "å–®æ©Ÿæ¨¡å¼";
            document.getElementById('status-text').innerText = "ğŸ’» å–®æ©Ÿæ¨¡å¼";
            document.getElementById('sub-status-text').innerText = "æ•¸æ“šå„²å­˜æ–¼æœ¬æ©Ÿ";
            document.getElementById('results-badge').innerText = "Local Storage";
            document.getElementById('results-badge').className = "bg-gray-600 text-white text-xs px-2 py-1 rounded";
            
            // Load local votes
            globalVotes = JSON.parse(localStorage.getItem('local_votes')) || {};
            window.updateGlobalVotes(globalVotes);
        }

        function initCloudUI() {
            document.getElementById('mode-indicator').innerText = "Firebase é€£ç·š";
            document.getElementById('status-text').innerText = "ğŸ”¥ é›²ç«¯åŒæ­¥ä¸­";
            document.getElementById('sub-status-text').innerText = "å³æ™‚è³‡æ–™åº«é€£ç·š";
            document.getElementById('results-badge').innerText = "Firebase Live";
            document.getElementById('results-badge').className = "bg-orange-600 text-white text-xs px-2 py-1 rounded animate-pulse";
        }

        // --- VOTING ACTIONS ---
        window.castVote = function(id, type, name, title) {
            const key = `${id}-${type}`;
            
            if (isLocalMode) {
                globalVotes[key] = (globalVotes[key] || 0) + 1;
                window.updateGlobalVotes(globalVotes);
                localStorage.setItem('local_votes', JSON.stringify(globalVotes));
                showToast(`å·²æŠ•çµ¦ #${id}-${type} (æœ¬æ©Ÿ)`);
            } else {
                // Firebase Mode
                if (window.castVoteFirebase) {
                    window.castVoteFirebase(id, type);
                } else {
                    alert("Firebase æ¨¡çµ„å°šæœªè¼‰å…¥å®Œæˆï¼Œè«‹ç¨å€™");
                }
            }
        }
        
        window.resetVotes = function() {
            if(confirm("ç¢ºå®šè¦é‡ç½®æ‰€æœ‰ç¥¨æ•¸å—ï¼Ÿ")) {
                if(isLocalMode) {
                    globalVotes = {};
                    localStorage.removeItem('local_votes');
                    window.updateGlobalVotes({});
                    closeResults();
                    showToast("æœ¬æ©Ÿç¥¨æ•¸å·²é‡ç½®");
                } else {
                    if (window.resetVotesFirebase) window.resetVotesFirebase();
                }
            }
        }

        // --- UI UPDATER (Exposed globally for modules to call) ---
        window.updateGlobalVotes = function(newVotes) {
            globalVotes = newVotes; // Update state
            
            // Update Detail Buttons
            Object.keys(globalVotes).forEach(key => {
                const countSpan = document.getElementById(`count-${key}`);
                if (countSpan) countSpan.innerText = globalVotes[key];
            });

            // Update Results Chart if open
            if (!document.getElementById('results-view').classList.contains('hidden')) {
                renderResultsChart();
            }

            // Update Nav Total
            const total = Object.values(globalVotes).reduce((a, b) => a + b, 0);
            const navLabel = document.getElementById('nav-live-count');
            if(navLabel) navLabel.innerText = total > 0 ? `ç›®å‰ç¸½ç¥¨æ•¸: ${total}` : 'æŸ¥çœ‹å³æ™‚æˆ°æ³';
        }

        // --- STANDARD UI FUNCTIONS ---
        window.showToast = function(message) {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerText = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        function renderCategories() {
            const grid = document.getElementById('categories-grid');
            grid.innerHTML = proposalsData.map(cat => `
                <div onclick="openDetail('${cat.id}')" class="bg-white rounded-xl shadow-sm border border-stone-100 p-6 cursor-pointer card-hover group transition-all duration-200">
                    <div class="flex items-center justify-between mb-4">
                        <span class="text-4xl bg-stone-50 p-3 rounded-full">${cat.icon}</span>
                        <span class="text-xs font-bold text-gray-400">#${cat.id}</span>
                    </div>
                    <h4 class="text-xl font-bold text-gray-800 group-hover:text-emerald-700 transition">${cat.name}</h4>
                    <p class="text-sm text-emerald-600 font-medium mb-2">${cat.slogan}</p>
                    <div class="mt-4 flex gap-2">
                        <span class="text-xs bg-emerald-50 text-emerald-700 px-2 py-1 rounded border border-emerald-100">æ–¹æ¡ˆ A</span>
                        <span class="text-xs bg-blue-50 text-blue-700 px-2 py-1 rounded border border-blue-100">æ–¹æ¡ˆ B</span>
                    </div>
                </div>
            `).join('');
        }

        function openDetail(id) {
            const cat = proposalsData.find(c => c.id === id);
            if (!cat) return;
            const contentDiv = document.getElementById('detail-content');
            contentDiv.innerHTML = `
                <div class="mb-6 border-b pb-4">
                    <div class="flex items-center gap-3 mb-2">
                        <span class="text-4xl">${cat.icon}</span>
                        <h2 class="text-3xl font-bold text-emerald-900">${cat.id} ${cat.name}</h2>
                    </div>
                    <p class="text-xl text-emerald-600 font-medium">${cat.slogan}</p>
                </div>
                <div class="flex border-b border-gray-200 mb-6">
                    <button onclick="switchTab('planA')" id="tab-btn-A" class="active-tab py-2 px-6 text-lg transition-colors w-1/2 md:w-auto">æ–¹æ¡ˆ A (åˆ¶åº¦)</button>
                    <button onclick="switchTab('planB')" id="tab-btn-B" class="inactive-tab py-2 px-6 text-lg transition-colors w-1/2 md:w-auto">æ–¹æ¡ˆ B (è¡Œå‹•)</button>
                </div>
                <div id="content-planA" class="fade-in">${renderPlanHTML(cat.id, cat.planA, 'emerald')}</div>
                <div id="content-planB" class="hidden fade-in">${renderPlanHTML(cat.id, cat.planB, 'blue')}</div>
            `;
            document.getElementById('detail-view').classList.remove('hidden');
            switchTab('planA');
        }

        function renderPlanHTML(catId, plan, color) {
            const bgClass = color === 'emerald' ? 'bg-emerald-50' : 'bg-blue-50';
            const textClass = color === 'emerald' ? 'text-emerald-800' : 'text-blue-800';
            const btnBg = color === 'emerald' ? 'bg-emerald-600 hover:bg-emerald-700' : 'bg-blue-600 hover:bg-blue-700';
            const currentVotes = globalVotes[`${catId}-${plan.type}`] || 0;

            return `
                <div class="${bgClass} border ${color === 'emerald'?'border-emerald-200':'border-blue-200'} rounded-lg p-6 mb-6 relative">
                    <div class="md:absolute md:top-6 md:right-6 mb-6 md:mb-0 z-10">
                        <button onclick="castVote('${catId}', '${plan.type}', '${proposalsData.find(c=>c.id===catId).name}', '${plan.title}')"
                                class="${btnBg} text-white px-6 py-3 rounded-full shadow-lg flex items-center gap-3 transition transform hover:scale-105 active:scale-95 w-full md:w-auto justify-center ring-2 ring-white">
                            <span class="text-xl animate-bounce">ğŸ—³ï¸</span>
                            <div class="text-left leading-tight">
                                <span class="block font-bold text-sm">æŠ•æˆ‘ä¸€ç¥¨</span>
                                <span class="block text-xs opacity-90 transition-all">ç›®å‰ <span id="count-${catId}-${plan.type}" class="font-bold text-lg">${currentVotes}</span> ç¥¨</span>
                            </div>
                        </button>
                    </div>
                    <h3 class="text-2xl font-bold ${textClass} mb-2 pr-0 md:pr-40">${plan.title}</h3>
                    <p class="text-gray-700 font-medium mb-4 pr-0 md:pr-40">${plan.desc}</p>
                    <div class="bg-white p-4 rounded-lg shadow-sm border border-gray-100">
                        <p class="font-bold text-gray-800">å…·é«”åšæ³•ï¼š</p>
                        <p class="text-gray-600">${plan.action}</p>
                    </div>
                    <div class="mt-4 flex gap-4 text-sm text-gray-500">
                        <div class="flex flex-col"><span class="text-xs uppercase">é›£æ˜“åº¦</span><div class="w-24 h-2 bg-gray-200 rounded-full mt-1"><div class="h-full ${color==='emerald'?'bg-emerald-500':'bg-blue-500'}" style="width: ${plan.effort * 10}%"></div></div></div>
                        <div class="flex flex-col"><span class="text-xs uppercase">å½±éŸ¿åŠ›</span><div class="w-24 h-2 bg-gray-200 rounded-full mt-1"><div class="h-full bg-yellow-400" style="width: ${plan.impact * 10}%"></div></div></div>
                    </div>
                </div>
            `;
        }

        window.switchTab = function(plan) {
            const btnA = document.getElementById('tab-btn-A');
            const btnB = document.getElementById('tab-btn-B');
            const contentA = document.getElementById('content-planA');
            const contentB = document.getElementById('content-planB');
            
            if(plan === 'planA') {
                btnA.className = "active-tab py-2 px-6 text-lg transition-colors w-1/2 md:w-auto border-b-2 border-emerald-800 text-emerald-800 font-bold";
                btnB.className = "inactive-tab py-2 px-6 text-lg transition-colors w-1/2 md:w-auto text-gray-500";
                contentA.classList.remove('hidden'); contentB.classList.add('hidden');
            } else {
                btnB.className = "active-tab py-2 px-6 text-lg transition-colors w-1/2 md:w-auto border-b-2 border-blue-800 text-blue-800 font-bold";
                btnA.className = "inactive-tab py-2 px-6 text-lg transition-colors w-1/2 md:w-auto text-gray-500";
                contentB.classList.remove('hidden'); contentA.classList.add('hidden');
            }
        }

        // --- Chart & Results ---
        let resultsChartInstance = null;
        window.openResults = function() { document.getElementById('results-view').classList.remove('hidden'); renderResultsChart(); }
        window.closeResults = function() { document.getElementById('results-view').classList.add('hidden'); }
        window.closeDetail = function() { document.getElementById('detail-view').classList.add('hidden'); }
        window.scrollToSection = function(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }

        function initChart() {
            const ctx = document.getElementById('strategyChart').getContext('2d');
            const dataPoints = [];
            proposalsData.forEach(cat => {
                dataPoints.push({ x: cat.planA.effort, y: cat.planA.impact, r: 12, category: cat.name, plan: 'A', title: cat.planA.title, id: cat.id });
                dataPoints.push({ x: cat.planB.effort, y: cat.planB.impact, r: 10, category: cat.name, plan: 'B', title: cat.planB.title, id: cat.id });
            });
            new Chart(ctx, {
                type: 'bubble',
                data: { datasets: [{ label: 'æ–¹æ¡ˆ A', data: dataPoints.filter(d=>d.plan==='A'), backgroundColor: 'rgba(16, 185, 129, 0.7)', borderColor: 'rgba(6, 95, 70, 1)' }, { label: 'æ–¹æ¡ˆ B', data: dataPoints.filter(d=>d.plan==='B'), backgroundColor: 'rgba(59, 130, 246, 0.7)', borderColor: 'rgba(30, 64, 175, 1)' }] },
                options: { responsive: true, maintainAspectRatio: false, scales: { x: { min: 0, max: 10, title: { display: true, text: 'é›£æ˜“åº¦ (å³é›£)' }}, y: { min: 0, max: 10, title: { display: true, text: 'å½±éŸ¿åŠ› (ä¸Šé«˜)' }}}, onClick: (e, el) => { if(el.length) openDetail(el[0].element.$context.raw.id); } }
            });
        }

        function renderResultsChart() {
            const ctx = document.getElementById('resultsChart').getContext('2d');
            let rankedData = [];
            proposalsData.forEach(cat => {
                ['A', 'B'].forEach(type => {
                    const key = `${cat.id}-${type}`;
                    const count = globalVotes[key] || 0;
                    if(count >= 0) {
                        rankedData.push({
                            label: `${cat.id}-${type} ${type==='A'?cat.planA.title:cat.planB.title}`,
                            count: count,
                            color: type==='A' ? 'rgba(16, 185, 129, 0.8)' : 'rgba(59, 130, 246, 0.8)'
                        });
                    }
                });
            });
            rankedData.sort((a,b) => b.count - a.count);
            
            if (resultsChartInstance) resultsChartInstance.destroy();
            resultsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: { labels: rankedData.map(d=>d.label.substring(0,15)+'...'), datasets: [{ label: 'å¾—ç¥¨æ•¸', data: rankedData.map(d=>d.count), backgroundColor: rankedData.map(d=>d.color), borderRadius: 4 }] },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, scales: { x: { beginAtZero: true, ticks: { stepSize: 1 } } }, plugins: { legend: { display: false } } }
            });
        }

        window.onload = function() { renderCategories(); initChart(); checkConfig(); };
    </script>
</body>
</html>
